@model HairNovaShop.Models.Product
@{
    ViewData["Title"] = Model.Name + " - HairNovaShop";
    var imageList = new List<string>();
    if (!string.IsNullOrEmpty(Model.Images))
    {
        try
        {
            imageList = System.Text.Json.JsonSerializer.Deserialize<List<string>>(Model.Images) ?? new List<string>();
        }
        catch { }
    }
    if (!string.IsNullOrEmpty(Model.MainImage) && !imageList.Contains(Model.MainImage))
    {
        imageList.Insert(0, Model.MainImage);
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/detail.css" asp-append-version="true" />
}

<section class="page-header">
    <div class="container">
        <h1 class="page-title">Cửa Hàng</h1>
        <div class="breadcrumb">
            <a asp-controller="Home" asp-action="Index">Trang Chủ</a> / <a asp-controller="Shop" asp-action="Index">Cửa Hàng</a> / <span>@Model.Name</span>
        </div>
    </div>
</section>

<section class="product-detail-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-5 gallery-container">
                <div class="main-image-box">
                    <button class="gallery-nav-btn prev" onclick="changeImage(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <img id="mainImg" src="@(imageList.Any() ? imageList[0] : "/images/placeholder.png")" alt="@Model.Name">
                    <button class="gallery-nav-btn next" onclick="changeImage(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                @if (imageList.Count > 1)
                {
                    <div class="thumb-list">
                        @for (int i = 0; i < imageList.Count; i++)
                        {
                            <div class="thumb-item @(i == 0 ? "active" : "")" onclick="changeImageTo(@i)">
                                <img src="@imageList[i]" alt="Thumbnail @(i + 1)">
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="col-lg-7 product-info-col">
                <span class="p-cat">@(Model.Category?.Name ?? "Sản phẩm")</span>
                <h2 class="p-title">
                    @Model.Name
                    @if (Model.Stock > 0)
                    {
                        <span class="stock-badge">Còn hàng</span>
                    }
                    else
                    {
                        <span class="stock-badge" style="background: #e74c3c;">Hết hàng</span>
                    }
                </h2>

                @if (Model.Rating > 0)
                {
                    <div class="p-rating">
                        <div class="stars">
                            @for (int i = 0; i < 5; i++)
                            {
                                <i class="fa-solid fa-star @(i < (int)Model.Rating ? "" : "text-muted")"></i>
                            }
                        </div>
                        <span>@Model.Rating.ToString("F1") (@Model.ReviewCount Đánh Giá)</span>
                    </div>
                }

                <div class="p-price" id="productPrice">
                    @Model.Price.ToString("N0")đ
                    @if (Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price)
                    {
                        <del>@Model.OriginalPrice.Value.ToString("N0")đ</del>
                    }
                </div>

                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <p class="p-desc">@Model.Description</p>
                }

                @{
                    var variantsJson = Model.StockByCapacity ?? "[]";
                    var variants = new List<Dictionary<string, object>>();
                    try
                    {
                        variants = System.Text.Json.JsonSerializer.Deserialize<List<Dictionary<string, object>>>(variantsJson) ?? new List<Dictionary<string, object>>();
                    }
                    catch { }
                    
                    if (variants.Any())
                    {
                        <div class="option-group">
                            <span class="option-label">Dung Tích</span>
                            @foreach (var variant in variants)
                            {
                                var capacity = variant?.GetValueOrDefault("Capacity")?.ToString() ?? "";
                                var price = variant?.GetValueOrDefault("Price");
                                var stock = variant?.GetValueOrDefault("Stock")?.ToString() ?? "0";
                                var variantPrice = price != null ? decimal.Parse(price.ToString() ?? "0") : (decimal?)null;
                                var variantStock = int.Parse(stock);
                                
                                <button class="size-btn variant-btn" 
                                        data-capacity="@capacity"
                                        data-price="@(variantPrice?.ToString("N0") ?? Model.Price.ToString("N0"))"
                                        data-stock="@variantStock"
                                        onclick="selectVariant(this, '@capacity', @(variantPrice?.ToString() ?? "null"), @variantStock)">
                                    @capacity @(variantStock > 0 ? $"(Còn {variantStock})" : "(Hết hàng)")
                                </button>
                            }
                        </div>
                        <input type="hidden" id="selectedCapacity" value="" />
                        <input type="hidden" id="selectedVariantPrice" value="@Model.Price" />
                        <input type="hidden" id="selectedVariantStock" value="@Model.Stock" />
                        <input type="hidden" id="basePrice" value="@Model.Price" />
                        <input type="hidden" id="baseStock" value="@Model.Stock" />
                    }
                }

                <div class="action-row">
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty(-1)">-</button>
                        <input type="text" value="1" class="qty-input" id="qtyInput" readonly>
                        <button class="qty-btn" onclick="updateQty(1)">+</button>
                    </div>
                    <button class="add-cart-btn" onclick="addToCart(@Model.Id)"><i class="fa-solid fa-cart-plus"></i> Thêm Giỏ Hàng</button>
                    <button class="buy-now-btn" onclick="buyNow(@Model.Id)">Mua Ngay</button>
                    <button class="wishlist-btn" onclick="addToWishlist(@Model.Id)"><i class="fa-regular fa-heart"></i></button>
                </div>

                <div class="meta-info">
                    @if (!string.IsNullOrEmpty(Model.SKU))
                    {
                        <p><span>SKU :</span> @Model.SKU</p>
                    }
                    @if (!string.IsNullOrEmpty(Model.Tags))
                    {
                        <p><span>Tags :</span> @Model.Tags</p>
                    }
                    <p class="share-icons">
                        <span>Share :</span>
                        <i class="fa-brands fa-facebook-f"></i>
                        <i class="fa-brands fa-twitter"></i>
                        <i class="fa-brands fa-instagram"></i>
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="product-tabs-section">
    <div class="container">
        <div class="nav-tabs">
            <button class="nav-link active" onclick="openTab(event, 'desc')">Mô Tả</button>
            <button class="nav-link" onclick="openTab(event, 'info')">Thông Tin Thêm</button>
            <button class="nav-link" onclick="openTab(event, 'review')">Đánh Giá (@Model.ReviewCount)</button>
        </div>

        <div id="desc" class="tab-content tab-content-box active">
            <div class="desc-text">
                @if (!string.IsNullOrEmpty(Model.DetailedDescription))
                {
                    @Html.Raw(Model.DetailedDescription.Replace("\n", "<br>"))
                }
                else if (!string.IsNullOrEmpty(Model.Description))
                {
                    <p>@Model.Description</p>
                }
            </div>
        </div>

        <div id="info" class="tab-content tab-content-box">
            <table class="tech-table">
                @if (!string.IsNullOrEmpty(Model.Brand))
                {
                    <tr><th>Thương hiệu</th><td>@Model.Brand</td></tr>
                }
                @if (!string.IsNullOrEmpty(Model.Origin))
                {
                    <tr><th>Xuất xứ</th><td>@Model.Origin</td></tr>
                }
                @{
                    var variantsJsonForInfo = Model.StockByCapacity ?? "[]";
                    var variantsForInfo = new List<Dictionary<string, object>>();
                    try
                    {
                        variantsForInfo = System.Text.Json.JsonSerializer.Deserialize<List<Dictionary<string, object>>>(variantsJsonForInfo) ?? new List<Dictionary<string, object>>();
                    }
                    catch { }
                    
                    if (variantsForInfo.Any())
                    {
                        var capacities = variantsForInfo.Select(v => v?.GetValueOrDefault("Capacity")?.ToString() ?? "").Where(c => !string.IsNullOrEmpty(c)).ToList();
                        if (capacities.Any())
                        {
                            <tr><th>Dung tích</th><td>@string.Join(", ", capacities)</td></tr>
                        }
                    }
                }
                @if (!string.IsNullOrEmpty(Model.ExpiryDate))
                {
                    <tr><th>Hạn sử dụng</th><td>@Model.ExpiryDate</td></tr>
                }
            </table>
        </div>

        <div id="review" class="tab-content tab-content-box">
            <div class="review-summary">
                <div class="rating-big-box">
                    <div class="rating-num">@Model.Rating.ToString("F1") <span>out of 5</span></div>
                    <div class="rating-stars-big">
                        @for (int i = 0; i < 5; i++)
                        {
                            <i class="fa-solid fa-star @(i < (int)Model.Rating ? "" : "text-muted")"></i>
                        }
                    </div>
                    <p style="color:#888;">(@Model.ReviewCount Reviews)</p>
                </div>
            </div>
            <div class="text-center p-4">
                <p>Chức năng đánh giá đang được phát triển.</p>
            </div>
        </div>
    </div>
</section>


<script>
let currentImageIndex = 0;
const images = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(imageList));

function changeImage(direction) {
    if (images.length === 0) return;
    currentImageIndex += direction;
    if (currentImageIndex < 0) currentImageIndex = images.length - 1;
    if (currentImageIndex >= images.length) currentImageIndex = 0;
    document.getElementById('mainImg').src = images[currentImageIndex];
    updateThumbnailActive();
}

function changeImageTo(index) {
    currentImageIndex = index;
    document.getElementById('mainImg').src = images[index];
    updateThumbnailActive();
}

function updateThumbnailActive() {
    document.querySelectorAll('.thumb-item').forEach((item, index) => {
        item.classList.toggle('active', index === currentImageIndex);
    });
}

function selectVariant(btn, capacity, price, stock) {
    // Remove active class from all variant buttons
    document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('active'));
    // Add active class to selected button
    btn.classList.add('active');
    
    // Update hidden fields
    document.getElementById('selectedCapacity').value = capacity;
    document.getElementById('selectedVariantPrice').value = price || document.getElementById('basePrice').value;
    document.getElementById('selectedVariantStock').value = stock;
    
    // Update price display
    const priceEl = document.getElementById('productPrice');
    if (price) {
        priceEl.innerHTML = parseFloat(price).toLocaleString('vi-VN') + 'đ';
    } else {
        priceEl.innerHTML = '@Model.Price.ToString("N0")đ';
        @if (Model.OriginalPrice.HasValue && Model.OriginalPrice > Model.Price)
        {
            <text>
            priceEl.innerHTML += '<del>@Model.OriginalPrice.Value.ToString("N0")đ</del>';
            </text>
        }
    }
    
    // Update quantity if it exceeds stock
    const qtyInput = document.getElementById('qtyInput');
    const currentQty = parseInt(qtyInput.value);
    if (currentQty > stock) {
        qtyInput.value = stock > 0 ? stock : 1;
    }
    
    // Update stock badge
    const stockBadge = document.querySelector('.stock-badge');
    if (stockBadge) {
        if (stock > 0) {
            stockBadge.textContent = 'Còn hàng';
            stockBadge.style.background = '';
        } else {
            stockBadge.textContent = 'Hết hàng';
            stockBadge.style.background = '#e74c3c';
        }
    }
}

function updateQty(change) {
    const input = document.getElementById('qtyInput');
    const selectedStock = parseInt(document.getElementById('selectedVariantStock')?.value || '@Model.Stock');
    let qty = parseInt(input.value) + change;
    if (qty < 1) qty = 1;
    if (qty > selectedStock) qty = selectedStock;
    input.value = qty;
}

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("nav-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}

function addToCart(productId) {
    // TODO: Implement
    console.log('Add to cart:', productId);
}

function buyNow(productId) {
    // TODO: Implement
    console.log('Buy now:', productId);
}

function addToWishlist(productId) {
    // TODO: Implement
    console.log('Add to wishlist:', productId);
}
</script>
